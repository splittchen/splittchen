{% extends "base.html" %}

{% block title %}History - {{ group.name }} - Splittchen{% endblock %}

{% block content %}
<div class="container py-4 pb-5 mb-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-clock-history me-2"></i>Group History
                    </h2>
                    <p class="text-muted mb-0">
                        <strong>{{ group.name }}</strong> - Activity and audit log
                    </p>
                </div>
                <a href="{{ url_for('main.view_group', share_token=group.share_token) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Group
                </a>
            </div>
        </div>
    </div>

    <!-- Group Name Card -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="mb-1">{{ group.name }}</h4>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <small class="text-muted">
                            <i class="bi bi-people me-1"></i>{{ group.participants|length }} participants
                        </small>
                        {% if group.is_recurring %}
                            <span class="badge bg-primary">
                                <i class="bi bi-arrow-repeat me-1"></i>Recurring
                            </span>
                        {% endif %}
                        {% if group.is_expired %}
                            <span class="badge bg-danger">
                                <i class="bi bi-clock me-1"></i>Expired
                            </span>
                        {% elif group.expires_at %}
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-clock me-1"></i>Exp {{ group.expires_at.strftime('%d.%m.%Y') }}
                            </span>
                        {% endif %}
                        {% if group.is_settled %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>Settled
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>Activity Log
                        <small class="text-muted">(Last 100 activities)</small>
                    </h5>
                </div>
                <div class="card-body">
                    {% if audit_logs %}
                        <div class="timeline">
                            {% for log in audit_logs %}
                                <div class="timeline-item mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                    <div class="d-flex">
                                        <div class="timeline-icon me-3">
                                            {% if log.action == 'expense_added' %}
                                                <i class="bi bi-plus-circle text-success"></i>
                                            {% elif log.action == 'expense_deleted' %}
                                                <i class="bi bi-trash text-danger"></i>
                                            {% elif log.action == 'expense_updated' or log.action == 'expense_edited' %}
                                                <i class="bi bi-pencil text-warning"></i>
                                            {% elif log.action == 'participant_added' %}
                                                <i class="bi bi-person-plus text-primary"></i>
                                            {% elif log.action == 'participant_removed' %}
                                                <i class="bi bi-person-dash text-danger"></i>
                                            {% elif log.action == 'participant_updated' %}
                                                <i class="bi bi-person-gear text-warning"></i>
                                            {% elif log.action == 'participant_invited' %}
                                                <i class="bi bi-envelope-plus text-primary"></i>
                                            {% elif log.action == 'invitation_resent' %}
                                                <i class="bi bi-envelope text-info"></i>
                                            {% elif log.action == 'expenses_transferred' %}
                                                <i class="bi bi-arrow-right text-info"></i>
                                            {% elif log.action == 'group_settled' %}
                                                <i class="bi bi-check-circle text-success"></i>
                                            {% elif log.action == 'group_settled_period' %}
                                                <i class="bi bi-calendar-check text-success"></i>
                                            {% elif log.action == 'group_reopened' %}
                                                <i class="bi bi-unlock text-warning"></i>
                                            {% elif log.action == 'expiration_removed' %}
                                                <i class="bi bi-calendar-x text-info"></i>
                                            {% else %}
                                                <i class="bi bi-record-circle text-muted"></i>
                                            {% endif %}
                                        </div>
                                        <div class="timeline-content flex-grow-1">
                                            <!-- Date at top on mobile, side on desktop -->
                                            <small class="text-muted d-block d-md-none mb-1">
                                                <i class="bi bi-clock me-1"></i>{{ log.created_at.strftime('%d.%m.%Y at %H:%M') }}
                                            </small>
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <p class="mb-1"><strong>{{ log.description }}</strong></p>
                                                    {% if log.performed_by %}
                                                        <small class="text-muted">
                                                            <i class="bi bi-person me-1"></i>by {{ log.performed_by }}
                                                        </small>
                                                    {% endif %}
                                                    
                                                    <!-- Additional details for specific actions -->
                                                    {% if log.details %}
                                                        <div class="mt-2">
                                                            {% if log.action == 'expense_added' or log.action == 'expense_updated' or log.action == 'expense_edited' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    Amount: {{ log.details.expense_currency }}{{ "%.2f"|format(log.details.expense_amount) }}
                                                                    | Paid by: {{ log.details.paid_by_name }}
                                                                    | Split between: {{ log.details.split_count }} participant{{ 's' if log.details.split_count != 1 else '' }}
                                                                    {% if log.details.expense_category %}| Category: {{ log.details.expense_category }}{% endif %}
                                                                </small>
                                                            {% elif log.action == 'expense_deleted' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    Amount: {{ log.details.expense_currency }}{{ "%.2f"|format(log.details.expense_amount) }}
                                                                    | Paid by: {{ log.details.paid_by_name }}
                                                                    | Split between: {{ log.details.split_count }} participant{{ 's' if log.details.split_count != 1 else '' }}
                                                                </small>
                                                            {% elif log.action == 'expenses_transferred' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    Transferred {{ log.details.expense_count }} expense{{ 's' if log.details.expense_count != 1 else '' }} 
                                                                    from {{ log.details.from_participant }} to {{ log.details.to_participant }}
                                                                </small>
                                                            {% elif log.action == 'participant_added' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    {% if log.details.added_by_admin %}
                                                                        Added by admin
                                                                    {% else %}
                                                                        Joined via invitation link
                                                                    {% endif %}
                                                                    {% if log.details.participant_email %}
                                                                        | Email: {{ log.details.participant_email }}
                                                                    {% endif %}
                                                                </small>
                                                            {% elif log.action == 'participant_removed' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    {% if log.details.removed_participant_email %}
                                                                        Email: {{ log.details.removed_participant_email }}
                                                                    {% endif %}
                                                                    {% if log.details.had_expenses %}
                                                                        | Had expenses that were transferred
                                                                    {% endif %}
                                                                </small>
                                                            {% elif log.action == 'participant_updated' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    {% if log.details.changes %}
                                                                        Changes: {{ log.details.changes|join(', ') }}
                                                                    {% endif %}
                                                                </small>
                                                            {% elif log.action == 'participant_invited' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    Email: {{ log.details.invited_email }}
                                                                    | Invitation sent
                                                                </small>
                                                            {% elif log.action == 'invitation_resent' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    Email: {{ log.details.participant_email }}
                                                                    | Resent by admin
                                                                </small>
                                                            {% elif log.action == 'group_settled' or log.action == 'group_settled_period' %}
                                                                <small class="text-muted d-block">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    Period: {{ log.details.period_name }}
                                                                    | Expenses archived: {{ log.details.expenses_archived }}
                                                                    | Total amount: {{ "%.2f"|format(log.details.total_amount) }}
                                                                    | Email reports: {{ log.details.emails_sent }}/{{ log.details.participants_count }}
                                                                    {% if log.details.group_closed %}| Group closed{% endif %}
                                                                </small>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <!-- Date on side for desktop only -->
                                                <small class="text-muted text-nowrap ms-3 d-none d-md-block">
                                                    {{ log.created_at.strftime('%d.%m.%Y at %H:%M') }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-clock-history text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">No Activity Yet</h5>
                            <p class="text-muted">Group activities and changes will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-icon {
    width: 24px;
    text-align: center;
    font-size: 1.2rem;
}

.timeline-item:last-child {
    border-bottom: none !important;
}

.timeline-content {
    min-height: 30px;
}

/* Ensure content is visible on mobile with extra bottom padding */
@media (max-width: 767.98px) {
    .container {
        padding-bottom: 5rem !important;
        margin-bottom: 3rem !important;
    }
}
</style>
{% endblock %}